version: "3.12"
services:
  blackbox-exporter:
    configs:
    - source: prometheus-blackbox-exporter
    deploy:
      replicas: 1
      labels:
        io.prometheus.dockerswarm-services.should_be_probed: "false"
        io.prometheus.dockerswarm-tasks.should_be_scraped: "false"
        io.prometheus.role: blackbox-exporter
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      rollback_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      resources:
        limits:
          memory: "134217728"
      restart_policy:
        condition: any
        delay: 30s
        max_attempts: 15
        window: 15s
      placement:
        max_replicas_per_node: 1
    hostname: replica-{{.Task.Slot}}.blackbox-exporter.local
    image: prom/blackbox-exporter:v0.25.0
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    networks:
      prometheus_gwnetwork:
        aliases:
        - blackbox-exporter.local
      public: null
  cadvisor:
    command:
    - -docker_only
    configs:
    - source: prometheus-cadvisor
    deploy:
      mode: global
      labels:
        io.prometheus.dockerswarm-services.should_be_probed: "false"
        io.prometheus.dockerswarm-tasks.should_be_scraped: "false"
        io.prometheus.role: cadvisor
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      rollback_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      resources:
        limits:
          memory: "134217728"
      restart_policy:
        condition: any
        delay: 30s
        max_attempts: 15
        window: 15s
    hostname: replica-{{.Task.Slot}}.cadvisor.local
    image: gcr.io/cadvisor/cadvisor:v0.47.0
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    networks:
      prometheus_gwnetwork:
        aliases:
        - cadvisor.local
    volumes:
    - type: bind
      source: /
      target: /rootfs
      read_only: true
    - type: bind
      source: /var/run
      target: /var/run
      read_only: true
    - type: bind
      source: /sys
      target: /sys
      read_only: true
    - type: bind
      source: /var/lib/docker
      target: /var/lib/docker
      read_only: true
    - type: bind
      source: /var/run/docker.sock
      target: /var/run/docker.sock
      read_only: true
    - type: bind
      source: /dev/disk
      target: /dev/disk
      read_only: true
    - type: bind
      source: /dev/kmsg
      target: /dev/kmsg
      read_only: true
  grafana:
    deploy:
      replicas: 1
      labels:
        io.prometheus.enabled: "true"
        io.prometheus.job_name: grafana
        io.prometheus.scrape_port: "3000"
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      rollback_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      restart_policy:
        condition: any
        delay: 30s
        max_attempts: 15
        window: 15s
      placement:
        constraints:
        - node.role == manager
        max_replicas_per_node: 1
    hostname: replica-{{.Task.Slot}}.grafana.local
    image: swarmlibs/grafana:main
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    networks:
      grafana:
        aliases:
        - grafana.local
      prometheus:
        aliases:
        - grafana.svc.cluster.local
      prometheus_gwnetwork: null
      public:
        aliases:
        - grafana.svc.cluster.local
    ports:
    - target: 3000
      published: 3000
    volumes:
    - type: volume
      source: grafana-data
      target: /var/lib/grafana
    - type: volume
      source: grafana-dashboards
      target: /etc/grafana/dashboards
    - type: volume
      source: grafana-provisioning-dashboards
      target: /etc/grafana/provisioning/dashboards
    - type: volume
      source: grafana-provisioning-datasources
      target: /etc/grafana/provisioning/datasources
  grafana-dashboard-provider:
    command:
    - --output-ext=json
    - --output-dir=/grafana-dashboards.d
    - --prometheus-scrape-config-label=io.grafana.dashboard
    configs:
    - source: gf-dashboard-grafana-metrics
    - source: gf-dashboard-prometheus-stats
    - source: gf-dashboard-prometheus-stats-v2
    - source: gf-dashboard-dockerswarm-nodes-dashboard
    - source: gf-dashboard-dockerswarm-services-endpoints
    - source: gf-dashboard-dockerswarm-services
    - source: gf-dashboard-cadvisor
    - source: gf-dashboard-node-exporter
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      rollback_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      resources:
        limits:
          memory: "134217728"
      restart_policy:
        condition: any
        delay: 15s
        max_attempts: 15
        window: 10s
      placement:
        constraints:
        - node.labels.services.promstack_grafana == true
        max_replicas_per_node: 1
    image: swarmlibs/prometheus-config-provider:main
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    volumes:
    - type: volume
      source: grafana-dashboards
      target: /grafana-dashboards.d
    - type: bind
      source: /var/run/docker.sock
      target: /var/run/docker.sock
      read_only: true
  grafana-provisioning-config-reloader:
    depends_on:
    - grafana
    - grafana-dashboard-provider
    - grafana-provisioning-dashboard-provider
    - grafana-provisioning-datasource-provider
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      rollback_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      resources:
        limits:
          memory: "134217728"
      restart_policy:
        condition: any
        delay: 15s
        max_attempts: 15
        window: 10s
      placement:
        constraints:
        - node.labels.services.promstack_grafana == true
        max_replicas_per_node: 1
    environment:
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
      GF_SERVER_DOMAIN: replica-{{.Task.Slot}}.grafana.local
    image: swarmlibs/grafana-provisioning-config-reloader:main
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    networks:
      grafana: null
    volumes:
    - type: volume
      source: grafana-provisioning-config-reloader
      target: /data
    - type: volume
      source: grafana-provisioning-dashboards
      target: /etc/grafana/provisioning/dashboards
    - type: volume
      source: grafana-provisioning-datasources
      target: /etc/grafana/provisioning/datasources
      read_only: true
  grafana-provisioning-dashboard-provider:
    command:
    - --output-dir=/grafana-provisioning-dashboards.d
    - --prometheus-scrape-config-label=io.grafana.provisioning.dashboard
    configs:
    - source: gf-provisioning-dashboards
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      rollback_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      resources:
        limits:
          memory: "134217728"
      restart_policy:
        condition: any
        delay: 15s
        max_attempts: 15
        window: 10s
      placement:
        constraints:
        - node.labels.services.promstack_grafana == true
        max_replicas_per_node: 1
    image: swarmlibs/prometheus-config-provider:main
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    volumes:
    - type: volume
      source: grafana-provisioning-dashboards
      target: /grafana-provisioning-dashboards.d
    - type: bind
      source: /var/run/docker.sock
      target: /var/run/docker.sock
      read_only: true
  grafana-provisioning-datasource-provider:
    command:
    - --output-dir=/grafana-provisioning-datasources.d
    - --prometheus-scrape-config-label=io.grafana.provisioning.datasource
    configs:
    - source: gf-provisioning-datasource-prometheus
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      rollback_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      resources:
        limits:
          memory: "134217728"
      restart_policy:
        condition: any
        delay: 15s
        max_attempts: 15
        window: 10s
      placement:
        constraints:
        - node.labels.services.promstack_grafana == true
        max_replicas_per_node: 1
    image: swarmlibs/prometheus-config-provider:main
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    volumes:
    - type: volume
      source: grafana-provisioning-datasources
      target: /grafana-provisioning-datasources.d
    - type: bind
      source: /var/run/docker.sock
      target: /var/run/docker.sock
      read_only: true
  node-exporter:
    command:
    - --path.rootfs=/rootfs
    - --collector.textfile.directory=/etc/node-exporter
    - --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)
    - --no-collector.ipvs
    configs:
    - source: node-exporter-node-meta
      target: /etc/node-exporter/node_meta.prom
    - source: prometheus-node-exporter
    deploy:
      mode: global
      labels:
        io.prometheus.dockerswarm-services.should_be_probed: "false"
        io.prometheus.dockerswarm-tasks.should_be_scraped: "false"
        io.prometheus.role: node-exporter
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      rollback_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      resources:
        limits:
          memory: "134217728"
      restart_policy:
        condition: any
        delay: 30s
        max_attempts: 15
        window: 15s
    hostname: replica-{{.Task.Slot}}.node-exporter.local
    image: prom/node-exporter:v1.8.1
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    networks:
      prometheus_gwnetwork:
        aliases:
        - node-exporter.local
    volumes:
    - type: bind
      source: /
      target: /rootfs
      read_only: true
  prometheus:
    command:
    - --verbose
    - --file=/run/configs/prometheus.yaml.tmpl
    - --out=/prometheus-configs.d/prometheus.yaml
    configs:
    - source: prometheus.yaml.tmpl
      target: /run/configs/prometheus.yaml.tmpl
    deploy:
      mode: global
      resources:
        limits:
          memory: "134217728"
      placement:
        constraints:
        - node.labels.services.promstack_prometheus_server == true
    environment:
      PROMETHEUS_CLUSTER_NAME: ${PROMETHEUS_CLUSTER_NAME:-{{ index .Service.Labels
        "com.docker.stack.namespace"}}}
      PROMETHEUS_CLUSTER_REPLICA: ${PROMETHEUS_CLUSTER_REPLICA:-replica-{{.Task.Slot}}}
    image: swarmlibs/genconfig:main
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    volumes:
    - type: volume
      source: prometheus-configs
      target: /prometheus-configs.d
  prometheus-config-provider:
    command:
    - --output-dir=/prometheus-configs.d/scrape-configs
    configs:
    - source: prometheus-dockerswarm-nodes
    - source: prometheus-dockerswarm-services-endpoints-host
    - source: prometheus-dockerswarm-services-endpoints-ingress
    - source: prometheus-dockerswarm-tasks
    deploy:
      mode: global
      labels:
        io.prometheus.role: prometheus-config-provider
      update_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      rollback_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      resources:
        limits:
          memory: "134217728"
      restart_policy:
        condition: any
        delay: 15s
        max_attempts: 15
        window: 10s
      placement:
        constraints:
        - node.labels.services.promstack_prometheus_server == true
    image: swarmlibs/prometheus-config-provider:main
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    volumes:
    - type: volume
      source: prometheus-configs
      target: /prometheus-configs.d
    - type: bind
      source: /var/run/docker.sock
      target: /var/run/docker.sock
      read_only: true
  prometheus-config-reloader:
    command:
    - --listen-address=:8080
    - --config-file=/prometheus-configs.d/prometheus.yaml
    - --watched-dir=/prometheus-configs.d/scrape-configs
    - --reload-url=http://prometheus.internal:9090/-/reload
    - --runtimeinfo-url=http://prometheus.internal:9090/api/v1/status/runtimeinfo
    - --watch-interval=15s
    - --reload-timeout=10s
    depends_on:
    - prometheus
    - prometheus-server
    - prometheus-config-provider
    deploy:
      mode: global
      labels:
        io.prometheus.dockerswarm-services.should_be_probed: "false"
        io.prometheus.enabled: "true"
        io.prometheus.job_name: prometheus-config-reloader
        io.prometheus.role: prometheus-config-reloader
        io.prometheus.scrape_port: "8080"
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      rollback_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      resources:
        limits:
          memory: "134217728"
      restart_policy:
        condition: any
        delay: 30s
        window: 15s
      placement:
        constraints:
        - node.labels.services.promstack_prometheus_server == true
    image: quay.io/prometheus-operator/prometheus-config-reloader:v0.74.0
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    networks:
      prometheus_internal: null
    volumes:
    - type: volume
      source: prometheus-configs
      target: /prometheus-configs.d
  prometheus-server:
    command:
    - --config.file=/prometheus-configs.d/prometheus.yaml
    - --storage.tsdb.path=/prometheus
    - --web.console.libraries=/usr/share/prometheus/console_libraries
    - --web.console.templates=/usr/share/prometheus/consoles
    - --web.enable-lifecycle
    - --log.level=info
    configs:
    - source: prometheus-prometheus
      target: /etc/prometheus/scrape-configs/prometheus.yaml
    depends_on:
    - prometheus
    deploy:
      replicas: 1
      labels:
        io.prometheus.dockerswarm-services.should_be_probed: "false"
        io.prometheus.dockerswarm-tasks.should_be_scraped: "false"
        io.prometheus.role: prometheus
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      rollback_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      restart_policy:
        condition: any
        delay: 30s
        max_attempts: 15
        window: 15s
      placement:
        constraints:
        - node.role == manager
        max_replicas_per_node: 1
    extra_hosts:
    - host.docker.internal:host-gateway
    hostname: replica-{{.Task.Slot}}.prometheus.local
    image: prom/prometheus:v2.45.6
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    networks:
      prometheus:
        aliases:
        - prometheus.local
      prometheus_gwnetwork:
        aliases:
        - prometheus.local
      prometheus_internal:
        aliases:
        - prometheus.internal
      public:
        aliases:
        - prometheus.svc.cluster.local
    user: "0:0"
    volumes:
    - type: bind
      source: /var/run/docker.sock
      target: /var/run/docker.sock
      read_only: true
    - type: volume
      source: prometheus
      target: /prometheus
    - type: volume
      source: prometheus-configs
      target: /prometheus-configs.d
  pushgateway:
    configs:
    - source: prometheus-pushgateway
    deploy:
      replicas: 1
      labels:
        io.prometheus.dockerswarm-services.should_be_probed: "false"
        io.prometheus.dockerswarm-tasks.should_be_scraped: "false"
        io.prometheus.role: pushgateway
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      rollback_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 15s
        max_failure_ratio: 0.1
      resources:
        limits:
          memory: "134217728"
      restart_policy:
        condition: any
        delay: 30s
        max_attempts: 15
        window: 15s
      placement:
        max_replicas_per_node: 1
    hostname: replica-{{.Task.Slot}}.pushgateway.local
    image: prom/pushgateway:v1.9.0
    logging:
      driver: json-file
      options:
        max-file: "5"
        max-size: 12m
    networks:
      prometheus:
        aliases:
        - pushgateway.svc.cluster.local
      prometheus_gwnetwork:
        aliases:
        - pushgateway.local
networks:
  grafana: {}
  prometheus:
    name: prometheus
    external: true
  prometheus_gwnetwork:
    name: prometheus_gwnetwork
    external: true
  prometheus_internal:
    internal: true
  public:
    name: public
    external: true
volumes:
  grafana-dashboards: {}
  grafana-data: {}
  grafana-provisioning-config-reloader: {}
  grafana-provisioning-dashboards: {}
  grafana-provisioning-datasources: {}
  prometheus: {}
  prometheus-configs: {}
configs:
  gf-dashboard-cadvisor:
    name: gf-dashboard-cadvisor-v1
    file: grafana/dashboards/cadvisor.json
    labels:
      io.grafana.dashboard: "true"
  gf-dashboard-dockerswarm-nodes-dashboard:
    name: gf-dashboard-dockerswarm-nodes-dashboard-v1
    file: grafana/dashboards/dockerswarm-nodes.json
    labels:
      io.grafana.dashboard: "true"
  gf-dashboard-dockerswarm-services:
    name: gf-dashboard-dockerswarm-services-v1
    file: grafana/dashboards/dockerswarm-services.json
    labels:
      io.grafana.dashboard: "true"
  gf-dashboard-dockerswarm-services-endpoints:
    name: gf-dashboard-dockerswarm-services-endpoints-v1
    file: grafana/dashboards/dockerswarm-services-endpoints.json
    labels:
      io.grafana.dashboard: "true"
  gf-dashboard-grafana-metrics:
    name: gf-dashboard-grafana-metrics-v1
    file: grafana/dashboards/grafana-metrics.json
    labels:
      io.grafana.dashboard: "true"
  gf-dashboard-node-exporter:
    name: gf-dashboard-node-exporter-v1
    file: grafana/dashboards/node-exporter.json
    labels:
      io.grafana.dashboard: "true"
  gf-dashboard-prometheus-stats:
    name: gf-dashboard-prometheus-stats-v1
    file: grafana/dashboards/prometheus-stats.json
    labels:
      io.grafana.dashboard: "true"
  gf-dashboard-prometheus-stats-v2:
    name: gf-dashboard-prometheus-stats-v2
    file: grafana/dashboards/prometheus-2-0-stats.json
    labels:
      io.grafana.dashboard: "true"
  gf-provisioning-dashboards:
    name: gf-provisioning-dashboards-v1
    file: grafana/provisioning/dashboards/grafana-dashboards.yml
    labels:
      io.grafana.provisioning.dashboard: "true"
  gf-provisioning-datasource-prometheus:
    name: gf-provisioning-datasource-prometheus-v1
    file: grafana/provisioning/datasources/prometheus.yaml
    labels:
      io.grafana.provisioning.datasource: "true"
  node-exporter-node-meta:
    name: node-exporter-node-meta-v1
    file: node-exporter/node_meta.prom
  prometheus:
    name: prometheus
    external: true
  prometheus-blackbox-exporter:
    name: prometheus-blackbox-exporter-v1
    file: blackbox-exporter/prometheus/blackbox-exporter.yml
    labels:
      io.prometheus.scrape_config: "true"
  prometheus-cadvisor:
    name: prometheus-cadvisor-v1
    file: cadvisor/prometheus/cadvisor.yml
    labels:
      io.prometheus.scrape_config: "true"
  prometheus-dockerswarm-nodes:
    name: prometheus-dockerswarm-nodes-v1
    file: prometheus/configs/scrape-configs/dockerswarm-nodes.yaml
    labels:
      io.prometheus.scrape_config: "true"
  prometheus-dockerswarm-services-endpoints-host:
    name: prometheus-dockerswarm-services-endpoints-host-v1
    file: prometheus/configs/scrape-configs/dockerswarm-services-endpoints-host.yaml
    labels:
      io.prometheus.scrape_config: "true"
  prometheus-dockerswarm-services-endpoints-ingress:
    name: prometheus-dockerswarm-services-endpoints-ingress-v1
    file: prometheus/configs/scrape-configs/dockerswarm-services-endpoints-ingress.yaml
    labels:
      io.prometheus.scrape_config: "true"
  prometheus-dockerswarm-tasks:
    name: prometheus-dockerswarm-tasks-v1
    file: prometheus/configs/scrape-configs/dockerswarm-tasks.yaml
    labels:
      io.prometheus.scrape_config: "true"
  prometheus-node-exporter:
    name: prometheus-node-exporter-v1
    file: node-exporter/prometheus/node_exporter.yml
    labels:
      io.prometheus.scrape_config: "true"
  prometheus-prometheus:
    name: prometheus-prometheus-v1
    file: prometheus/configs/scrape-configs/prometheus.yaml
    template_driver: golang
  prometheus-pushgateway:
    name: prometheus-pushgateway-v1
    file: pushgateway/prometheus/pushgateway.yml
    labels:
      io.prometheus.scrape_config: "true"
  prometheus.yaml.tmpl:
    name: prometheus.yaml.tmpl-v1
    file: prometheus/configs/prometheus.yaml.tmpl
x-default-logging:
  driver: json-file
  options:
    max-file: "5"
    max-size: 12m
x-exporter-resources-constraints:
  limits:
    memory: 128M
